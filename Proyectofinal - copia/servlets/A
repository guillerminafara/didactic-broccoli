import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import javax.servlet.ServletException;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.mindrot.jbcrypt.BCrypt;

public class LoginServlet extends HttpServlet {

    private static final int SESSION_TIMEOUT_SECONDS = 30 * 60; // 30 minutos

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        request.setCharacterEncoding("UTF-8");
        response.setContentType("text/html;charset=UTF-8");

        String emailInput = request.getParameter("email");
        String passwordInput = request.getParameter("password");

        if (emailInput == null || passwordInput == null || emailInput.isBlank() || passwordInput.isBlank()) {
            request.setAttribute("error", "Email y contraseña son requeridos.");
            request.getRequestDispatcher("/login.jsp").forward(request, response);
            return;
        }

        String jdbcUrl = "jdbc:mysql://localhost/tu_base_de_datos?allowPublicKeyRetrieval=true&useSSL=false";
        String dbUser = "alumno";
        String dbPass = "mipassword";

        String sql = "SELECT id_usuario, nombre, apellido, email, contrasena FROM usuario WHERE email = ?";

        try (Connection conn = DriverManager.getConnection(jdbcUrl, dbUser, dbPass);
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setString(1, emailInput);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    String hashedPassword = rs.getString("contrasena");
                    if (BCrypt.checkpw(passwordInput, hashedPassword)) {
                        // Autenticación correcta
                        // Previene session fixation: invalidar sesión previa y crear una nueva
                        HttpSession oldSession = request.getSession(false);
                        if (oldSession != null) {
                            oldSession.invalidate();
                        }
                        HttpSession session = request.getSession(true);
                        session.setMaxInactiveInterval(SESSION_TIMEOUT_SECONDS);

                        // Guarda solo lo necesario en la sesión
                        session.setAttribute("userId", rs.getInt("id_usuario"));
                        session.setAttribute("userName", rs.getString("nombre"));
                        session.setAttribute("userSurname", rs.getString("apellido"));
                        session.setAttribute("userEmail", rs.getString("email"));
                        session.setAttribute("isAuthenticated", true);

                        // Asegurar cookie de sesión (mejor configurar en el contenedor)
                        Cookie sessionCookie = new Cookie("JSESSIONID", session.getId());
                        sessionCookie.setHttpOnly(true);
                        sessionCookie.setSecure(request.isSecure()); // true si usas HTTPS
                        sessionCookie.setPath(request.getContextPath().isEmpty() ? "/" : request.getContextPath());
                        response.addCookie(sessionCookie);

                        // Redirigir a la página principal
                        response.sendRedirect(request.getContextPath() + "/paginaPrincipal.jsp");
                        return;
                    } else {
                        // Contraseña incorrecta
                        request.setAttribute("error", "Email o contraseña incorrectos.");
                        request.getRequestDispatcher("/login.jsp").forward(request, response);
                        return;
                    }
                } else {
                    // Usuario no encontrado
                    request.setAttribute("error", "Email o contraseña incorrectos.");
                    request.getRequestDispatcher("/login.jsp").forward(request, response);
                    return;
                }
            }

        } catch (SQLException e) {
            // Log en servidor y mensaje genérico al usuario
            e.printStackTrace();
            request.setAttribute("error", "Error en el servidor. Intenta más tarde.");
            request.getRequestDispatcher("/login.jsp").forward(request, response);
        }
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.sendRedirect(req.getContextPath() + "/login.jsp");
    }
}